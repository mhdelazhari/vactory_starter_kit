<?php

/**
 * @file
 * This was auto-generated by Vactory Generator module.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\user\Entity\User;

/**
 * Implements hook_entity_presave().
 */
function vactory_facebook_pixel_entity_presave(EntityInterface $entity) {
  $facebookValidationService = \Drupal::service('vactory_facebook_pixel.facebook_validation');
  $check_route_names = $facebookValidationService->routeNamesCheck();
  $current_route_name = \Drupal::routeMatch()->getRouteName();
  if ($entity->bundle() == 'user' && $entity->isNew() && ($current_route_name == 'user.register' || $check_route_names)) {
    $pixel_data = $facebookValidationService->facebookValidation($entity, 'CompleteRegistration');
    if ($pixel_data['token'] != NULL && !empty($entity->mail->value)) {
      \Drupal::state()->set('fbtrace_' . $entity->mail->value, $pixel_data);
    }
  }
}

/**
 * Implements hook_preprocass_page().
 */
function vactory_facebook_pixel_preprocess_page(&$variables) {
  $facebookValidationService = \Drupal::service('vactory_facebook_pixel.facebook_validation');
  $user = User::load(\Drupal::currentUser()->id());
  if ($facebookValidationService->pathCheck() && $facebookValidationService->roleCheck() && $facebookValidationService->languageCheck() && $facebookValidationService->contentTypesCheck()) {
    $pixel_data = $facebookValidationService->facebookValidation($user, 'PageView');
    if (!empty($pixel_data) && !empty($pixel_data['token'])) {
      $variables['#attached']['library'][] = 'vactory_facebook_pixel/vactory_facebook_pixel.script';
      $variables['#attached']['drupalSettings']['fb_validation_token']['PageView'] = $pixel_data['token'];
      $variables['#attached']['drupalSettings']['fb_validation_event_id']['PageView'] = $pixel_data['eventID'];
    }
  }

  // Expose facebook pixel token in dataLayer for completeRegistration event.
  if (!empty($user)) {
    $pixel_data = \Drupal::state()->get('fbtrace_' . $user->mail->value);
    if (!empty($pixel_data) && !empty($pixel_data['token'])) {
      $variables['#attached']['library'][] = 'vactory_facebook_pixel/vactory_facebook_pixel.script';
      $variables['#attached']['drupalSettings']['fb_validation_token']['CompleteRegistration'] = $pixel_data['token'];
      $variables['#attached']['drupalSettings']['fb_validation_event_id']['CompleteRegistration'] = $pixel_data['eventID'];
    }
    \Drupal::state()->delete('fbtrace_' . $user->mail->value);
  }
}
